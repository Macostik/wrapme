//
//  WLMenu.m
//  WrapLive
//
//  Created by Sergey Maximenko on 6/24/14.
//  Copyright (c) 2014 Ravenpod. All rights reserved.
//

#import "WLMenu.h"
#import <AudioToolbox/AudioServices.h>
#import "UIFont+CustomFonts.h"
#import "UIColor+CustomColors.h"
#import "UIView+Shorthand.h"

@implementation WLMenuItem @end

@interface WlMenuItemButton : UIButton

@property (weak, nonatomic) WLMenuItem* item;

@end

@implementation WlMenuItemButton

+ (id)buttonWithType:(UIButtonType)buttonType {
    WlMenuItemButton *button = [super buttonWithType:buttonType];
    return button;
}

- (void)setHighlighted:(BOOL)highlighted {
    [super setHighlighted:highlighted];
    self.backgroundColor = highlighted ? [UIColor WL_darkGrayColor] : [UIColor blackColor];
}

@end

@interface WLMenu () <UIGestureRecognizerDelegate>

@property (strong, nonatomic) NSMutableArray* items;

@property (strong, nonatomic) NSArray* buttons;

@property (weak, nonatomic) UILongPressGestureRecognizer* longPressGestureRecognizer;

@property (weak, nonatomic) UIPanGestureRecognizer* panGestureRecognizer;

@end

@implementation WLMenu
{
    BOOL _vibrate:YES;
    CGPoint _point;
}

@synthesize vibrate = _vibrate;

+ (NSHashTable*)menus {
    static NSHashTable *menus = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        menus = [NSHashTable weakObjectsHashTable];
    });
    return menus;
}

+ (instancetype)menuWithView:(UIView *)view configuration:(BOOL (^)(WLMenu *))configuration {
    return [[self alloc] initWithView:view configuration:configuration];
}

+ (instancetype)menuWithView:(UIView *)view title:(NSString *)title block:(WLBlock)block {
    return [[self alloc] initWithView:view title:title block:block];
}

+ (void)hide {
    for (WLMenu* menu in [self menus]) {
        [menu hide];
    }
}

- (instancetype)initWithView:(UIView *)view configuration:(BOOL (^)(WLMenu *))configuration {
    self = [super init];
    if (self) {
        self.view = view;
        self.backgroundColor = [UIColor clearColor];
        self.configuration = configuration;
        [[WLMenu menus] addObject:self];
        UILongPressGestureRecognizer* longPressGestureRecognizer = [[UILongPressGestureRecognizer alloc] initWithTarget:self action:@selector(present:)];
        longPressGestureRecognizer.delegate = self;
        [view addGestureRecognizer:longPressGestureRecognizer];
        self.longPressGestureRecognizer = longPressGestureRecognizer;
        
        UIPanGestureRecognizer* panGestureRecognizer = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(pan:)];
        panGestureRecognizer.delegate = self;
        panGestureRecognizer.enabled = NO;
        [view addGestureRecognizer:panGestureRecognizer];
        self.panGestureRecognizer = panGestureRecognizer;
    }
    return self;
}

- (instancetype)initWithView:(UIView *)view title:(NSString *)title block:(WLBlock)block {
    return [self initWithView:view configuration:^BOOL (WLMenu *menu) {
        [menu addItem:title block:block];
        return YES;
    }];
}

- (void)setEnabled:(BOOL)enabled {
    [super setEnabled:enabled];
    self.longPressGestureRecognizer.enabled = enabled;
}

- (void)hide {
    self.panGestureRecognizer.enabled = NO;
    __weak typeof(self)weakSelf = self;
    [UIView animateWithDuration:0.2 delay:0.0f options:UIViewAnimationOptionCurveEaseInOut animations:^{
        [weakSelf.buttons enumerateObjectsUsingBlock:^(UIView* subview, NSUInteger idx, BOOL *stop) {
            subview.alpha = 0.0f;
        }];
    } completion:^(BOOL finished) {
        [weakSelf.items removeAllObjects];
        [weakSelf removeFromSuperview];
    }];
}

- (void)show {
    [self show:self.view.center];
}

- (void)show:(CGPoint)point {
    UIView* superview = self.view.window;
    if (!superview) {
        return;
    }
    self.panGestureRecognizer.enabled = YES;
    if (!self.items) {
        self.items = [NSMutableArray array];
    } else {
        [self.items removeAllObjects];
    }
    if (self.configuration && self.configuration(self)) {
        self.frame = superview.bounds;
        _point = [self.view convertPoint:point toView:superview];
        [self.subviews makeObjectsPerformSelector:@selector(removeFromSuperview)];
        NSMutableArray* buttons = [NSMutableArray array];
        for (WLMenuItem* item in self.items) {
            WlMenuItemButton* button = [WlMenuItemButton buttonWithType:UIButtonTypeCustom];
            button.item = item;
            [self addSubview:button];
            [button addTarget:self action:@selector(selectedItem:) forControlEvents:UIControlEventTouchUpInside];
            button.frame = CGRectMake(0, 0, 88, 40);
            button.center = _point;
            button.backgroundColor = [UIColor blackColor];
            button.clipsToBounds = YES;
            [button setTitle:item.title forState:UIControlStateNormal];
            [button setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
            [button.titleLabel setFont:[UIFont regularSmallFont]];
            button.layer.cornerRadius = 10;
            [buttons addObject:button];
        }
        self.buttons = [buttons copy];
        CGFloat count = [self.subviews count];
        [self.buttons enumerateObjectsUsingBlock:^(UIView* subview, NSUInteger idx, BOOL *stop) {
            CGFloat angle = 2*M_PI*((float)idx/count) - M_PI_4;
            CGPoint center = subview.center;
            center.x += 44*cosf(angle);
            center.y += 44*sinf(angle);
            subview.center = center;
            subview.alpha = 0.0f;
        }];
        [superview addSubview:self];
        __weak typeof(self)weakSelf = self;
        [UIView animateWithDuration:0.2 delay:0.0f options:UIViewAnimationOptionCurveEaseInOut animations:^{
            [weakSelf.buttons enumerateObjectsUsingBlock:^(UIView* subview, NSUInteger idx, BOOL *stop) {
                subview.alpha = 1.0f;
            }];
        } completion:^(BOOL finished) {
        }];
        [self setNeedsDisplay];
    }
}

- (void)addItem:(NSString *)title block:(WLBlock)block {
    if (!self.items) {
        self.items = [NSMutableArray array];
    }
    WLMenuItem* item = [[WLMenuItem alloc] init];
    item.title = title;
    item.block = block;
    [self.items addObject:item];
}

- (void)present:(UILongPressGestureRecognizer*)sender {
    if (sender.state == UIGestureRecognizerStateBegan && sender.view.userInteractionEnabled) {
		if (self.vibrate) {
			AudioServicesPlaySystemSound(kSystemSoundID_Vibrate);
		}
        sender.view.userInteractionEnabled = NO;
        [self show:[sender locationInView:sender.view]];
        sender.view.userInteractionEnabled = YES;
	}
}

- (void)pan:(UIPanGestureRecognizer*)sender {
    NSLog(@"sdfdsfdfds");
}

- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
    [self hide];
}

- (void)selectedItem:(WlMenuItemButton*)sender {
    WLBlock block = sender.item.block;
    if (block) {
        block();
    }
    [self hide];
}

#pragma mark - UIGestureRecognizerDelegate

- (BOOL)gestureRecognizer:(UIGestureRecognizer *)gestureRecognizer shouldRecognizeSimultaneouslyWithGestureRecognizer:(UIGestureRecognizer *)otherGestureRecognizer {
    if (gestureRecognizer == self.longPressGestureRecognizer) {
        return otherGestureRecognizer == self.panGestureRecognizer;
    } else if (gestureRecognizer == self.panGestureRecognizer) {
        return otherGestureRecognizer == self.longPressGestureRecognizer;
    }
    return NO;
}

@end
